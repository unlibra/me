---
import "../styles/global.css";
import "@fontsource/ibm-plex-sans-jp/400.css";
import "@fontsource/ibm-plex-sans-jp/500.css";
import "@fontsource/ibm-plex-sans-jp/700.css";
import { Image } from "astro:assets";

import Avatar from "../components/Avatar.astro";
import SponsorButton from "../components/SponsorButton.astro";
import ShareIcon from "../components/icons/ShareIcon.astro";
import ParodyIcon from "../components/icons/ParodyIcon.astro";
import LocationIcon from "../components/icons/LocationIcon.astro";
import LinkIcon from "../components/icons/LinkIcon.astro";
import CalendarIcon from "../components/icons/CalendarIcon.astro";
import miraImg from "../assets/works/mira.webp";
import fostyNaturalImg from "../assets/works/fosty-natural.webp";
import fostyDarkImg from "../assets/works/fosty-dark.webp";
import eightPxImg from "../assets/works/8pxapp.webp";
import iromideImg from "../assets/works/iromide.webp";

interface Project {
  id: string;
  title: string;
  description: string;
  category: string;
  image?: ImageMetadata;
  year?: string;
  link?: string;
}

const site = {
  title: "unlibra.com",
  url: "https://unlibra.com",
  description:
    "unlibraのXオマージュポートフォリオサイト。Webアプリ開発と自作キーボードなど制作実績を紹介しています。",
  ogImage: "/ogp.png",
};

const categories = {
  web: "Webアプリ",
  keyboard: "自作キーボード",
} as const;

const profile = {
  name: "unlibra",
  username: "unlibra",
  bio: `このサイトはXオマージュのポートフォリオです
これまでの制作実績をまとめています`,
  location: "Tokyo, Japan",
  website: "https://github.com/unlibra",
  sponsor: "https://ofuse.me/unlibra",
};

const buildDate = new Date();
const updatedAt = buildDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
});

const allWorks: Project[] = [
  {
    id: "1",
    title: "mira zero",
    description: `40%分割カラムスタッガード配列ロープロ(ChocV1)キーボード。終売。
初めて作った自作キーボード。`,
    category: "keyboard",
    year: "2024",
    image: miraImg,
  },
  {
    id: "2",
    title: "fosty natural",
    description: `HHKBインスパイア配列40%ロープロファイル(ChocV2)キーボード。アルミカラーモデル。非売品。
6作目ぐらい。エンドゲーム。`,
    category: "keyboard",
    year: "2025",
    image: fostyNaturalImg,
  },
  {
    id: "3",
    title: "fosty dark",
    description: `HHKBインスパイア配列40%ロープロファイル(ChocV2)キーボード。ブラックモデル。非売品。
黒もほしくなったので作った。`,
    category: "keyboard",
    year: "2025",
    image: fostyDarkImg,
  },
  {
    id: "4",
    title: "8px.app",
    description: `Favicon生成、カラーパレット作成、SVG最適化など、Web・アプリ開発者のためのツールセット。
Tailwindに馴染むカラーパレットを作りたいという想いから始まり、ついでに自分が使うWEBサービスの機能を集約した。`,
    category: "web",
    year: "2025",
    image: eightPxImg,
    link: "https://8px.app",
  },
  {
    id: "5",
    title: "推し色生成 イロマイド",
    description: `画像からカラーパレットを生成してチェキを作るサービス。
8px.app内のサービスとして公開。
画像からカラーパレット作るツール作ってるうちにこうなった。`,
    category: "web",
    year: "2025",
    image: iromideImg,
    link: "https://8px.app/iromide",
  },
];
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{site.title}</title>
    <meta name="description" content={site.description} />
    <link rel="canonical" href={site.url} />

    <!-- OGP -->
    <meta property="og:title" content={site.title} />
    <meta property="og:description" content={site.description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={site.url} />
    <meta property="og:image" content={site.url + site.ogImage} />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:site_name" content={site.title} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={site.title} />
    <meta name="twitter:description" content={site.description} />
    <meta name="twitter:image" content={site.url + site.ogImage} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
  </head>
  <body
    class="bg-base-primary min-h-screen text-x-base text-neutral-200 antialiased"
  >
    <div class="border-base-secondary mx-auto min-h-screen max-w-2xl border-x">
      <!-- Header Bar -->
      <header class="border-base-secondary border-b">
        <div class="flex items-center gap-6 px-4 py-3">
          <h1 class="text-lg font-semibold">{site.title}</h1>
        </div>
      </header>

      <!-- Banner Image -->
      <div
        class="from-accent-primary via-accent-secondary to-accent-primary relative aspect-3/1 bg-linear-to-r"
      >
        <!-- <Image src={bannerImg} alt="Banner" loading="eager" fetchpriority="high" class="w-full h-full object-cover" /> -->
      </div>

      <!-- Profile Section -->
      <div class="relative space-y-3 p-4">
        <!-- Avatar & Sponsor Button -->
        <div class="relative flex items-start justify-between">
          <!-- Avatar -->
          <div class="relative -mt-16 sm:-mt-20">
            <div
              class="border-base-primary bg-base-secondary size-24 overflow-hidden rounded-full border-4 sm:size-32"
            >
              <Avatar class="h-full w-full object-cover" />
            </div>
          </div>

          <!-- Share & Sponsor Buttons -->
          <div class="flex gap-2">
            <!-- Share Button -->
            <button
              id="share-btn"
              type="button"
              class="hidden cursor-pointer rounded-full border border-neutral-500 p-2 transition-colors hover:bg-neutral-700/60"
              aria-label="Share"
            >
              <ShareIcon class="size-5" />
            </button>

            <!-- Sponsor Button -->
            {profile.sponsor && <SponsorButton href={profile.sponsor} />}
          </div>
        </div>

        <!-- Name & Username -->
        <div>
          <h2 class="text-xl font-bold">{profile.name}</h2>
          <p class="text-neutral-500">@{profile.username}</p>
          <p class="mt-1 flex items-center gap-1 text-neutral-500 sm:text-base">
            <ParodyIcon class="size-5" />
            <span class="translate-y-px">パロディサイト</span>
          </p>
        </div>

        <!-- Bio -->
        <p class="whitespace-pre-line sm:text-base">{profile.bio}</p>

        <!-- Meta Info -->
        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-neutral-500">
          {
            profile.location && (
              <span class="flex items-center gap-1">
                <LocationIcon class="h-4 w-4" />
                <span class="translate-y-px">{profile.location}</span>
              </span>
            )
          }
          {
            profile.website && (
              <a
                href={profile.website}
                target="_blank"
                rel="noopener noreferrer"
                class="text-accent-secondary flex items-center gap-1 hover:underline"
              >
                <LinkIcon class="h-4 w-4" />
                <span>{profile.website.replace(/^https?:\/\//, "")}</span>
              </a>
            )
          }
          <span class="flex items-center gap-1">
            <CalendarIcon class="h-4 w-4" />
            <span class="translate-y-px">Updated {updatedAt}</span>
          </span>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="border-base-secondary border-b" aria-label="作品カテゴリ">
        <div class="flex justify-around" role="tablist">
          <button
            data-tab="all"
            role="tab"
            aria-selected="true"
            aria-controls="timeline"
            class="tab-btn hover:bg-base-secondary focus-visible:ring-accent-primary relative cursor-pointer p-4 font-medium whitespace-nowrap text-white transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-inset"
          >
            All
            <div
              class="bg-accent-primary absolute bottom-0 left-1/2 h-1 w-16 -translate-x-1/2 rounded-full"
            >
            </div>
          </button>
          {
            Object.entries(categories).map(([key, label]) => (
              <button
                data-tab={key}
                role="tab"
                aria-selected="false"
                aria-controls="timeline"
                class="tab-btn hover:bg-base-secondary focus-visible:ring-accent-primary relative cursor-pointer truncate p-4 font-medium whitespace-nowrap text-neutral-500 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-inset"
              >
                {label}
              </button>
            ))
          }
        </div>
      </nav>

      <!-- Timeline / Works -->
      <main>
        <div id="timeline" role="tabpanel" aria-label="作品一覧">
          {
            [...allWorks].reverse().map((work, index) => (
              <article
                class="work-item border-base-secondary hover:bg-base-secondary/50 border-b transition-colors"
                data-category={work.category}
              >
                <div class="p-4">
                  {/* Tweet Header */}
                  <div class="flex gap-3">
                    {/* Small Avatar */}
                    <div class="bg-base-secondary size-10 shrink-0 overflow-hidden rounded-full">
                      <Avatar class="size-full object-cover" />
                    </div>

                    <div class="min-w-0 flex-1">
                      {/* Name & Date */}
                      <div class="mb-1 flex items-baseline gap-1">
                        <span class="truncate font-semibold">
                          {profile.name}
                        </span>
                        <span class="text-neutral-500">
                          @{profile.username}
                        </span>
                        <span class="text-neutral-500">･</span>
                        <span class="leading-6 text-neutral-500">
                          {work.year}
                        </span>
                      </div>

                      {/* Title with Hashtag */}
                      <div class="mb-1 flex flex-wrap items-center gap-2">
                        <h3 class="text-lg font-bold">{work.title}</h3>
                        <button
                          class="hashtag-btn text-accent-secondary cursor-pointer hover:underline"
                          data-category={work.category}
                        >
                          #
                          {categories[
                            work.category as keyof typeof categories
                          ] || work.category}
                        </button>
                      </div>

                      {/* Description */}
                      <p class="mb-3 whitespace-pre-line text-neutral-300">
                        {work.description}
                      </p>

                      {/* Image */}
                      {work.image &&
                        (work.link ? (
                          <a
                            href={work.link}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="border-base-secondary bg-base-secondary mb-3 block aspect-video overflow-hidden rounded-2xl border"
                          >
                            <Image
                              src={work.image}
                              alt={work.title}
                              loading={index === 0 ? "eager" : "lazy"}
                              fetchpriority={index === 0 ? "high" : undefined}
                              class="size-full object-cover"
                            />
                          </a>
                        ) : (
                          <div class="border-base-secondary bg-base-secondary mb-3 block aspect-video overflow-hidden rounded-2xl border">
                            <Image
                              src={work.image}
                              alt={work.title}
                              loading={index === 0 ? "eager" : "lazy"}
                              fetchpriority={index === 0 ? "high" : undefined}
                              class="size-full object-cover"
                            />
                          </div>
                        ))}

                      {/* Link */}
                      {work.link && (
                        <a
                          href={work.link}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-accent-secondary inline-flex items-center gap-2 hover:underline"
                        >
                          <LinkIcon class="size-4" />
                          <span>{work.link}</span>
                        </a>
                      )}
                    </div>
                  </div>
                </div>
              </article>
            ))
          }
        </div>
      </main>

      <!-- End of Timeline (Tweet Style) -->
      <article id="end-of-timeline" class="border-base-secondary border-b">
        <div class="p-4">
          <div class="flex gap-3">
            <div
              class="bg-base-secondary h-10 w-10 shrink-0 overflow-hidden rounded-full"
            >
              <Avatar class="h-full w-full object-cover" />
            </div>
            <div class="min-w-0 flex-1">
              <div class="mb-1 flex items-baseline gap-1">
                <span class="truncate font-semibold">{profile.name}</span>
                <span class="text-neutral-500">@{profile.username}</span>
              </div>
              <p class="text-neutral-300">ここで終わりです</p>
            </div>
          </div>
        </div>
      </article>
    </div>

    <!-- Footer -->
    <footer class="px-4 py-8">
      <p class="mt-4 text-center text-sm text-neutral-400">
        &copy; {new Date().getFullYear()}
        {profile.name}
      </p>
    </footer>

    <script>
      // Web Share API
      const shareBtn = document.getElementById("share-btn");
      if (navigator.share && shareBtn) {
        shareBtn.classList.remove("hidden");
        shareBtn.addEventListener("click", async () => {
          try {
            await navigator.share({
              title: document.title,
              url: window.location.href,
            });
          } catch {
            // User cancelled or error
          }
        });
      }

      const tabButtons = document.querySelectorAll(".tab-btn");
      const workItems = document.querySelectorAll(".work-item");
      const hashtagButtons = document.querySelectorAll(".hashtag-btn");

      function switchTab(tab: string, updateHash = true) {
        // Update tab styles and aria-selected
        tabButtons.forEach((btn) => {
          btn.classList.remove("text-white");
          btn.classList.add("text-neutral-500");
          btn.setAttribute("aria-selected", "false");
          const indicator = btn.querySelector("div");
          if (indicator) indicator.remove();
        });

        const activeTab = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
        if (activeTab) {
          activeTab.classList.remove("text-neutral-500");
          activeTab.classList.add("text-white");
          activeTab.setAttribute("aria-selected", "true");
          const indicator = document.createElement("div");
          indicator.className =
            "absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-1 bg-accent-primary rounded-full";
          activeTab.appendChild(indicator);
        }

        // Filter works
        workItems.forEach((item) => {
          const category = item.getAttribute("data-category");
          if (tab === "all" || category === tab) {
            (item as HTMLElement).style.display = "block";
          } else {
            (item as HTMLElement).style.display = "none";
          }
        });

        // Update URL hash
        if (updateHash) {
          if (tab === "all") {
            history.pushState(null, "", window.location.pathname);
          } else {
            history.pushState(null, "", `#${tab}`);
          }
        }
      }

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const tab = button.getAttribute("data-tab");
          if (tab) switchTab(tab);
        });
      });

      hashtagButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const category = button.getAttribute("data-category");
          if (category) {
            switchTab(category);
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });
      });

      // Handle initial hash on page load
      const initialHash = window.location.hash.slice(1);
      if (initialHash) {
        switchTab(initialHash, false);
      }

      // Handle browser back/forward
      window.addEventListener("hashchange", () => {
        const hash = window.location.hash.slice(1) || "all";
        switchTab(hash, false);
      });
    </script>
  </body>
</html>
