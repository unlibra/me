---
import "@/styles/global.css";
import "@fontsource/ibm-plex-sans-jp/400.css";
import "@fontsource/ibm-plex-sans-jp/500.css";
import "@fontsource/ibm-plex-sans-jp/700.css";
import { Image } from "astro:assets";

import Avatar from "@/components/Avatar.astro";
import SponsorButton from "@/components/SponsorButton.astro";
import ShareIcon from "@/components/icons/ShareIcon.astro";
import ParodyIcon from "@/components/icons/ParodyIcon.astro";
import LocationIcon from "@/components/icons/LocationIcon.astro";
import LinkIcon from "@/components/icons/LinkIcon.astro";
import CalendarIcon from "@/components/icons/CalendarIcon.astro";
import PinIcon from "@/components/icons/PinIcon.astro";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";
import Analytics from "@/components/Analytics.astro";
import { locales, defaultLocale, getMessages } from "@/i18n";
import { site as siteConfig } from "@/config/site";
import { profile as profileConfig } from "@/config/profile";
import { works as worksConfig } from "@/config/works";

export function getStaticPaths() {
  return locales.map((locale) => ({
    params: { locale },
  }));
}

const { locale } = Astro.params;
const messages = getMessages(locale!);

const site = {
  ...siteConfig,
  title: siteConfig.title,
  description: messages.site.description,
};

const categories = {
  web: messages.categories.web,
  software: messages.categories.software,
  keyboard: messages.categories.keyboard,
} as const;

const profile = {
  ...profileConfig,
  bio: messages.profile.bio,
};

const buildDate = new Date();
const updatedAt = buildDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
});

// Build works list from config + messages
const allWorks = worksConfig.map((work, index) => ({
  ...work,
  // ID 0 is pinned
  id: index === 0 ? "0" : String(index),
  title: messages.works[work.id as keyof typeof messages.works].title,
  description: messages.works[work.id as keyof typeof messages.works].description,
}));

// Works are displayed in array order (first item is pinned)
const sortedWorks = allWorks;

// Convert URLs in text to clickable links
const linkify = (text: string): string => {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-accent-secondary hover:underline">$1</a>');
};

// Build locale-aware URLs (no trailing slash for cleaner URLs)
// canonical/hreflang: use site.canonicalUrl (always points to main site, not mirror)
// ogUrl: use site.url (for sharing, respects environment)
const canonicalUrl = `${site.canonicalUrl}/${locale}`;
const ogUrl = locale === defaultLocale ? site.url : `${site.url}/${locale}`;
const ogLocale = locale === "ja" ? "ja_JP" : "en_US";
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{site.title}</title>
    <meta name="description" content={site.description} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- hreflang for alternate languages (always points to main site) -->
    {locales.map((l) => (
      <link rel="alternate" hreflang={l} href={`${site.canonicalUrl}/${l}`} />
    ))}
    <link rel="alternate" hreflang="x-default" href={site.canonicalUrl} />

    <!-- OGP -->
    <meta property="og:title" content={site.title} />
    <meta property="og:description" content={site.description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:image" content={site.url + site.ogImage} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:site_name" content={site.title} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={site.title} />
    <meta name="twitter:description" content={site.description} />
    <meta name="twitter:image" content={site.url + site.ogImage} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
  </head>
  <body
    class="bg-base-primary text-x-base min-h-screen text-neutral-200 antialiased"
  >
    <div class="border-base-secondary mx-auto min-h-screen max-w-2xl border-x">
      <!-- Header Bar -->
      <header class="border-base-secondary border-b">
        <div class="flex items-center justify-between gap-6 px-4 py-3">
          <h1 class="text-lg font-semibold">
            <a href="/">{site.title}</a>
          </h1>
          <LanguageSwitcher />
        </div>
      </header>

      <!-- Banner Image -->
      <div
        class="from-accent-primary via-accent-secondary to-accent-primary relative aspect-3/1 bg-linear-to-r"
      >
        <!-- <Image src={bannerImg} alt="Banner" loading="eager" fetchpriority="high" class="w-full h-full object-cover" /> -->
      </div>

      <!-- Profile Section -->
      <div class="relative space-y-3 p-4">
        <!-- Avatar & Sponsor Button -->
        <div class="relative flex items-start justify-between">
          <!-- Avatar -->
          <div class="relative -mt-16 sm:-mt-20">
            <div
              class="border-base-primary bg-base-secondary size-24 overflow-hidden rounded-full border-4 sm:size-32"
            >
              <Avatar class="h-full w-full object-cover" />
            </div>
          </div>

          <!-- Share & Sponsor Buttons -->
          <div class="flex gap-2">
            <!-- Share Button -->
            <button
              id="share-btn"
              type="button"
              class="hidden cursor-pointer rounded-full border border-neutral-600 p-2 transition-colors hover:bg-neutral-700/60"
              aria-label="Share"
            >
              <ShareIcon class="size-5" />
            </button>

            <!-- Sponsor Button -->
            {profile.sponsor && <SponsorButton href={profile.sponsor} />}
          </div>
        </div>

        <!-- Name & Username -->
        <div>
          <h2 class="text-xl font-bold">{profile.name}</h2>
          <p class="text-neutral-500">@{profile.username}</p>
          <p class="mt-1 flex items-center gap-1 text-neutral-500">
            <ParodyIcon class="size-5" />
            <span class="translate-y-px">{messages.profile.parodyLabel}</span>
          </p>
        </div>

        <!-- Bio -->
        <p class="whitespace-pre-line">{profile.bio}</p>

        <!-- Meta Info -->
        <div class="flex flex-wrap gap-x-4 gap-y-1 text-neutral-500">
          {
            profile.location && (
              <span class="flex items-center gap-1">
                <LocationIcon class="h-4 w-4" />
                <span class="translate-y-px">{profile.location}</span>
              </span>
            )
          }
          {
            profile.website && (
              <a
                href={profile.website}
                target="_blank"
                rel="noopener noreferrer"
                class="text-accent-secondary flex items-center gap-1 hover:underline"
              >
                <LinkIcon class="h-4 w-4" />
                <span class="translate-y-px">
                  {profile.website.replace(/^https?:\/\//, "")}
                </span>
              </a>
            )
          }
          <span class="flex items-center gap-1">
            <CalendarIcon class="h-4 w-4" />
            <span class="translate-y-px">{messages.profile.updated} {updatedAt}</span>
          </span>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="border-base-secondary border-b" aria-label="作品カテゴリ">
        <div class="flex justify-around" role="tablist">
          <button
            data-tab="all"
            role="tab"
            aria-selected="true"
            aria-controls="timeline"
            class="tab-btn hover:bg-base-secondary focus-visible:ring-accent-primary relative cursor-pointer p-4 font-medium whitespace-nowrap transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-inset"
          >
            {messages.categories.all}
            <div
              class="tab-indicator bg-accent-primary absolute bottom-0 left-1/2 h-1 w-16 -translate-x-1/2 rounded-full"
            >
            </div>
          </button>
          {
            Object.entries(categories).map(([key, label]) => (
              <button
                data-tab={key}
                role="tab"
                aria-selected="false"
                aria-controls="timeline"
                class="tab-btn hover:bg-base-secondary focus-visible:ring-accent-primary relative cursor-pointer truncate p-4 font-medium whitespace-nowrap text-neutral-500 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-inset"
              >
                {label}
              </button>
            ))
          }
        </div>
      </nav>

      <!-- Timeline / Works -->
      <main>
        <div
          id="timeline"
          role="tabpanel"
          aria-label="作品一覧"
          class="pinned-mode flex flex-col"
        >
          {
            sortedWorks.map((work, index) => (
              <article
                class="work-item border-base-secondary border-b"
                data-category={work.category}
                data-id={work.id}
              >
                <div class="p-4">
                  {/* Pinned Label - only shown in All tab */}
                  {work.id === "0" && (
                    <div class="pinned-label text-x-sm mb-0.5 flex items-center gap-2 font-semibold text-neutral-500">
                      <PinIcon class="ml-7 size-4" />
                      <span>{messages.pinned}</span>
                    </div>
                  )}
                  {/* Tweet Header */}
                  <div class="flex gap-3">
                    {/* Small Avatar */}
                    <div class="bg-base-secondary size-10 shrink-0 overflow-hidden rounded-full">
                      <Avatar class="size-full object-cover" />
                    </div>

                    <div class="min-w-0 flex-1">
                      {/* Name & Date */}
                      <div class="mb-1 flex items-baseline gap-1">
                        <span class="truncate font-semibold">
                          {profile.name}
                        </span>
                        <span class="text-neutral-500">
                          @{profile.username}
                        </span>
                        <span class="text-neutral-500">･</span>
                        <span class="leading-6 text-neutral-500">
                          {work.year}
                        </span>
                      </div>

                      {/* Title with Hashtag */}
                      <div class="mb-1 flex flex-wrap items-center gap-2">
                        <h3 class="text-lg font-bold">{work.title}</h3>
                        <button
                          class="hashtag-btn text-accent-secondary cursor-pointer hover:underline"
                          data-category={work.category}
                        >{`#${categories[work.category as keyof typeof categories] || work.category}`}</button>
                      </div>

                      {/* Description */}
                      <p class="mb-3 whitespace-pre-line" set:html={linkify(work.description)} />

                      {/* Image */}
                      {work.image &&
                        (work.link ? (
                          <a
                            href={work.link}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="border-base-secondary bg-base-secondary mb-3 block aspect-video overflow-hidden rounded-2xl border"
                          >
                            <Image
                              src={work.image}
                              alt={work.title}
                              loading={index === 0 ? "eager" : "lazy"}
                              fetchpriority={index === 0 ? "high" : undefined}
                              class="size-full object-cover"
                            />
                          </a>
                        ) : (
                          <div class="border-base-secondary bg-base-secondary mb-3 block aspect-video overflow-hidden rounded-2xl border">
                            <Image
                              src={work.image}
                              alt={work.title}
                              loading={index === 0 ? "eager" : "lazy"}
                              fetchpriority={index === 0 ? "high" : undefined}
                              class="size-full object-cover"
                            />
                          </div>
                        ))}

                      {/* Link */}
                      {work.link && (
                        <a
                          href={work.link}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-accent-secondary inline-flex items-center gap-2 hover:underline"
                        >
                          <LinkIcon class="size-4" />
                          <span>{work.link}</span>
                        </a>
                      )}
                    </div>
                  </div>
                </div>
              </article>
            ))
          }
        </div>
      </main>

      <!-- End of Timeline (Tweet Style) -->
      <article id="end-of-timeline" class="border-base-secondary border-b">
        <div class="p-4">
          <div class="flex gap-3">
            <div
              class="bg-base-secondary h-10 w-10 shrink-0 overflow-hidden rounded-full"
            >
              <Avatar class="h-full w-full object-cover" />
            </div>
            <div class="min-w-0 flex-1">
              <div class="mb-1 flex items-baseline gap-1">
                <span class="truncate font-semibold">{profile.name}</span>
                <span class="text-neutral-500">@{profile.username}</span>
              </div>
              <p>{messages.footer.endOfTimeline}</p>
            </div>
          </div>
        </div>
      </article>
    </div>

    <!-- Footer -->
    <footer class="px-4 py-8">
      <p class="text-center text-neutral-500">
        <a href="/privacy" class="hover:underline">{messages.footer.privacyPolicy}</a>
      </p>
      <p class="mt-4 text-center text-neutral-500">
        &copy; {new Date().getFullYear()}
        {profile.name}
      </p>
    </footer>

    <script>
      // Web Share API
      const shareBtn = document.getElementById("share-btn");
      if (navigator.share && shareBtn) {
        shareBtn.classList.remove("hidden");
        shareBtn.addEventListener("click", async () => {
          try {
            await navigator.share({
              title: document.title,
              url: window.location.href,
            });
          } catch {
            // User cancelled or error
          }
        });
      }

      const tabButtons = document.querySelectorAll(".tab-btn");
      const workItems = document.querySelectorAll(".work-item");
      const hashtagButtons = document.querySelectorAll(".hashtag-btn");
      const timeline = document.getElementById("timeline");

      function switchTab(tab: string, updateHash = true) {
        // Update tab styles and aria-selected
        tabButtons.forEach((btn) => {
          btn.classList.remove("text-white");
          btn.classList.add("text-neutral-500");
          btn.setAttribute("aria-selected", "false");
          const indicator = btn.querySelector(".tab-indicator");
          if (indicator) indicator.remove();
        });

        const activeTab = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
        if (activeTab) {
          activeTab.classList.remove("text-neutral-500");
          activeTab.classList.add("text-white");
          activeTab.setAttribute("aria-selected", "true");
          const indicator = document.createElement("div");
          indicator.className =
            "tab-indicator absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-1 bg-accent-primary rounded-full";
          activeTab.appendChild(indicator);
        }

        // Toggle pinned mode (All tab only) - CSS handles label visibility and order
        if (timeline) {
          timeline.classList.toggle("pinned-mode", tab === "all");
        }

        // Filter works by category
        workItems.forEach((item) => {
          const category = item.getAttribute("data-category");
          if (tab === "all" || category === tab) {
            (item as HTMLElement).style.display = "block";
          } else {
            (item as HTMLElement).style.display = "none";
          }
        });

        // Update URL hash
        if (updateHash) {
          if (tab === "all") {
            history.pushState(null, "", window.location.pathname);
          } else {
            history.pushState(null, "", `#${tab}`);
          }
        }
      }

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const tab = button.getAttribute("data-tab");
          if (tab) switchTab(tab);
        });
      });

      hashtagButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const category = button.getAttribute("data-category");
          if (category) {
            switchTab(category);
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });
      });

      // Handle initial hash on page load
      const initialHash = window.location.hash.slice(1);
      if (initialHash) {
        switchTab(initialHash, false);
      }

      // Handle browser back/forward
      window.addEventListener("hashchange", () => {
        const hash = window.location.hash.slice(1) || "all";
        switchTab(hash, false);
      });
    </script>
    <Analytics />
  </body>
</html>
